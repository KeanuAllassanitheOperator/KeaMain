# sysctl.conf â€“ Optimized for Rocky Linux VMs running Docker workloads (small to heavy)
# Focused on container performance, network handling, memory efficiency, and isolation

# --- Network Tweaks for Containers ---
net.ipv4.ip_forward = 1                         # Required for Docker networking
net.ipv4.conf.all.forwarding = 1                # Ensure all interfaces can forward packets
net.ipv4.conf.default.rp_filter = 1             # Enable reverse path filtering (basic anti-spoofing)
net.ipv4.tcp_max_syn_backlog = 4096             # Improve handling of incoming TCP connections
net.core.somaxconn = 4096                       # Increase queue depth for accepting connections
net.core.netdev_max_backlog = 10000             # Larger packet processing queue

# --- TCP Optimization ---
net.ipv4.tcp_fin_timeout = 15                   # Reduce time for closed connections to be recycled
net.ipv4.tcp_tw_reuse = 1                       # Reuse TIME-WAIT sockets for fast container churn
net.ipv4.tcp_syncookies = 1                     # Protect against SYN flood attacks
net.ipv4.tcp_rmem = 4096 87380 16777216         # TCP receive buffer tuning
net.ipv4.tcp_wmem = 4096 65536 16777216         # TCP write buffer tuning
net.core.rmem_max = 16777216                    # Max socket read buffer
net.core.wmem_max = 16777216                    # Max socket write buffer

# --- Virtual Memory Settings ---
vm.max_map_count = 262144                       # Required for apps like Elasticsearch in containers
vm.swappiness = 10                              # Minimize swapping for container workloads
vm.dirty_background_ratio = 5                   # Lower threshold for background flush
vm.dirty_ratio = 10                             # Max dirty memory before forced flush
vm.vfs_cache_pressure = 50                      # Retain inode/dentry cache longer

# --- Filesystem and Process Tweaks ---
fs.inotify.max_user_watches = 1048576           # Allow many filesystem watchers (important for Docker volumes)
fs.file-max = 2097152                           # Increase max open files
fs.nr_open = 2097152                            # Upper limit for per-process open files
kernel.pid_max = 4194303                        # Allow more PID space for containerized processes

# --- Namespaces and Isolation ---
user.max_user_namespaces = 15000                # Increase namespaces for high container density

# --- Security-Related (SELinux enabled by default) ---
kernel.kptr_restrict = 1                        # Hide kernel pointers from unprivileged users
kernel.randomize_va_space = 2                   # Full ASLR for process memory protection
